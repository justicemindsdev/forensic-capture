<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forensic Evidence Viewer — ESSENTIAL EVIDENCE BUNDLE</title>
<script src="data.js"></script>
<style>
    /* ════════════════════════════════════════════════════
       GOV.UK DESIGN SYSTEM — Evidence Viewer
       ════════════════════════════════════════════════════ */
    :root {
      --black:   #0b0c0c;
      --white:   #ffffff;
      --grey-1:  #6f777b;   /* secondary text       */
      --grey-2:  #bfc1c3;   /* input borders        */
      --grey-3:  #dee0e2;   /* dividers             */
      --grey-4:  #f8f8f8;   /* page bg              */
      --blue:    #1d70b8;   /* links                */
      --focus:   #ffdd00;   /* focus / highlight    */
      --red:     #d4351c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      height: 100vh;
      background: var(--grey-4);
      color: var(--black);
      font-family: "GDS Transport", "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
      font-size: 16px;
    }

    /* ── GOV.UK BLACK HEADER (sidebar top) ── */
    .gov-header {
      background: var(--black);
      color: var(--white);
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 700;
      border-bottom: 3px solid var(--focus);   /* gold underline */
      flex-shrink: 0;
    }
    .gov-header .case-ref {
      font-weight: 400;
      color: #a9acae;
      font-size: 12px;
      margin-top: 2px;
    }

    /* ── LEFT PANEL ── */
    .toc-panel {
      width: 320px;
      background: var(--white);
      border-right: 1px solid var(--grey-3);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* Search block */
    .search-box {
      padding: 16px 20px;
      border-bottom: 1px solid var(--grey-3);
      flex-shrink: 0;
    }
    .search-label {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--black);
      margin-bottom: 6px;
    }
    input[type="text"] {
      width: 100%;
      background: var(--white);
      border: 2px solid var(--grey-2);
      color: var(--black);
      padding: 8px 10px;
      font-family: inherit;
      font-size: 16px;
      outline: none;
      border-radius: 0;
    }
    input[type="text"]:focus {
      outline: 3px solid var(--focus);
      outline-offset: 0;
      border-color: var(--black);
    }
    #matchCount {
      font-size: 13px;
      color: var(--blue);
      font-weight: 700;
      margin-top: 6px;
      min-height: 18px;
    }

    /* Stats strip */
    .stats-bar {
      padding: 7px 20px;
      background: var(--grey-4);
      border-bottom: 1px solid var(--grey-3);
      font-size: 12px;
      color: var(--grey-1);
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* TOC list */
    .toc-list { overflow-y: auto; flex: 1; }

    .toc-item {
      padding: 10px 16px 10px 20px;
      border-bottom: 1px solid var(--grey-3);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.12s;
      border-left: 4px solid transparent;
    }
    .toc-item:hover          { background: #f0f2f4; }
    .toc-item.active         { background: #eef2f7; border-left-color: var(--blue); }
    .toc-item.has-match      { border-left-color: var(--focus); background: #fffdf0; }
    .toc-item.active.has-match { border-left-color: var(--blue); background: #eef2f7; }

    .page-num {
      color: var(--blue);
      font-weight: 700;
      font-size: 14px;
    }
    .page-title {
      font-size: 12px;
      color: var(--grey-1);
      margin-top: 2px;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .match-badge {
      background: var(--focus);
      color: var(--black);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 2px;
      white-space: nowrap;
    }

    /* ── RIGHT PANEL: PAGE VIEWER ── */
    .viewer-panel {
      flex: 1;
      overflow-y: auto;
      padding: 20px 28px;
      background: #e8eaec;
      text-align: center;
      scroll-behavior: smooth;
    }

    .page-wrapper {
      display: inline-block;
      margin-bottom: 28px;
      text-align: left;
    }

    .page-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--grey-1);
      margin-bottom: 6px;
      letter-spacing: .01em;
    }

    /* The page container — highlight boxes position relative to this */
    .evidence-page {
      position: relative;
      display: inline-block;
      background: var(--white);
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }

    /* A4 FIT: shrink image so full page is visible in viewport */
    .evidence-img {
      display: block;
      max-height: calc(100vh - 68px);   /* viewport minus top padding */
      max-width: calc(100vw - 380px);   /* viewport minus sidebar + padding */
      width: auto;
      height: auto;
    }

    /* ── HIGHLIGHT OVERLAY — GOV.UK focus yellow ── */
    .highlight-box {
      position: absolute;
      background: rgba(255, 221, 0, 0.45);
      border: 2px solid rgba(0, 0, 0, 0.45);
      pointer-events: none;
      z-index: 10;
      animation: hl-pulse 2s ease-in-out infinite;
    }
    @keyframes hl-pulse { 0%,100% { opacity: 0.55; } 50% { opacity: 1; } }

    /* ── SCROLLBARS ── */
    ::-webkit-scrollbar            { width: 8px; }
    ::-webkit-scrollbar-track      { background: var(--white); }
    ::-webkit-scrollbar-thumb      { background: var(--grey-2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover{ background: var(--grey-1); }

    /* ── KEYBOARD HINT ── */
    .kb {
      position: fixed; bottom: 10px; right: 16px;
      font-size: 11px; color: var(--grey-1);
      pointer-events: none; z-index: 100;
      background: rgba(255,255,255,0.88);
      padding: 4px 10px; border-radius: 3px;
      border: 1px solid var(--grey-3);
    }
</style>
</head>
<body>

<!-- LEFT: CONTROLS -->
<div class="toc-panel">
    <div class="gov-header">
      Essential Evidence Bundle
      <div class="case-ref">111 pages &middot; Leah Farrer</div>
    </div>
    <div class="search-box">
        <label class="search-label" for="searchInput">Search</label>
        <input type="text" id="searchInput" placeholder="e.g. complaint, safeguarding…">
        <div id="matchCount"></div>
    </div>
    <div class="stats-bar">
        <span id="statsPages"></span>
        <span id="statsWords"></span>
    </div>
    <div class="toc-list" id="tocList"></div>
</div>

<!-- RIGHT: VIEWER -->
<div class="viewer-panel" id="viewerPanel"></div>

<div class="kb">↑↓ scroll &nbsp;|&nbsp; type to search</div>

<script>
(function () {
    const viewer   = document.getElementById('viewerPanel');
    const tocList  = document.getElementById('tocList');
    const TOTAL_PAGES = typeof EVIDENCE_DATA !== 'undefined' ? EVIDENCE_DATA.length : 0;

    // ── PRE-COMPUTE: group each page's words into lines ──
    // Words on the same baseline (y within 1.2%) belong to one line.
    // A line is highlighted as a single block — gives sentence-level context.
    const pageLines = {};                          // { pageNum → [[word,…], …] }

    function groupLines(wordMap) {
        if (!wordMap || !wordMap.length) return [];
        const sorted = [...wordMap].sort((a, b) => a.y - b.y || a.x - b.x);
        const lines  = [];
        let cur      = [sorted[0]];
        for (let i = 1; i < sorted.length; i++) {
            if (Math.abs(sorted[i].y - cur[0].y) < 1.2) {
                cur.push(sorted[i]);
            } else {
                lines.push(cur);
                cur = [sorted[i]];
            }
        }
        lines.push(cur);
        return lines;
    }

    function lineBBox(line) {
        let x1 = Infinity, y1 = Infinity, x2 = -Infinity, y2 = -Infinity;
        for (const w of line) {
            if (w.x         < x1) x1 = w.x;
            if (w.y         < y1) y1 = w.y;
            if (w.x + w.w   > x2) x2 = w.x + w.w;
            if (w.y + w.h   > y2) y2 = w.y + w.h;
        }
        return { x: x1, y: y1, w: x2 - x1, h: y2 - y1 };
    }

    // ── 1. INIT ──
    function init() {
        if (typeof EVIDENCE_DATA === 'undefined') {
            viewer.innerHTML = '<p style="color:#d4351c;font-size:18px;margin-top:100px">'
                + 'Error: data.js not loaded.</p>';
            return;
        }

        let totalWords = 0;
        EVIDENCE_DATA.forEach(item => {
            totalWords += item.word_map.length;
            pageLines[item.page] = groupLines(item.word_map);   // cache lines

            // ── TOC entry ──
            const tocItem        = document.createElement('div');
            tocItem.className    = 'toc-item';
            tocItem.id           = 'toc-' + item.page;
            tocItem.innerHTML    =
                '<div><span class="page-num">Page ' + item.page + '</span>' +
                '<div class="page-title">' + escHtml(item.title) + '</div></div>' +
                '<span class="match-badge" id="badge-' + item.page + '" style="display:none"></span>';
            tocItem.onclick      = () => scrollToPage(item.page);
            tocList.appendChild(tocItem);

            // ── Viewer page ──
            const wrapper        = document.createElement('div');
            wrapper.className    = 'page-wrapper';
            wrapper.id           = 'wrapper-' + item.page;

            const label          = document.createElement('div');
            label.className      = 'page-label';
            label.textContent    = 'Page ' + item.page + ' of ' + TOTAL_PAGES;

            const pageDiv        = document.createElement('div');
            pageDiv.className    = 'evidence-page';
            pageDiv.id           = 'page-' + item.page;
            pageDiv.innerHTML    = '<img src="' + item.image + '" class="evidence-img">';

            wrapper.appendChild(label);
            wrapper.appendChild(pageDiv);
            viewer.appendChild(wrapper);
        });

        document.getElementById('statsPages').textContent = TOTAL_PAGES + ' pages';
        document.getElementById('statsWords').textContent  = totalWords.toLocaleString() + ' indexed words';
    }

    // ── 2. SCROLL ──
    function scrollToPage(pageNum) {
        const el    = document.getElementById('wrapper-' + pageNum);
        const tocEl = document.getElementById('toc-'     + pageNum);
        document.querySelectorAll('.toc-item').forEach(i => i.classList.remove('active'));
        if (tocEl) tocEl.classList.add('active');
        if (el)    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ── 3. SEARCH — line-level highlights + TOC filter ──
    function performSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();

        // ── clear previous state ──
        document.querySelectorAll('.highlight-box').forEach(el => el.remove());
        document.querySelectorAll('.toc-item').forEach(i => {
            i.classList.remove('has-match', 'active');
            i.style.display = '';                       // restore visibility
        });
        document.querySelectorAll('.match-badge').forEach(b => {
            b.style.display  = 'none';
            b.textContent    = '';
        });

        if (query.length < 2) {
            document.getElementById('matchCount').textContent = '';
            return;
        }

        let totalMatches   = 0;
        let matchedPages   = 0;
        let firstMatchPage = null;

        EVIDENCE_DATA.forEach(item => {
            const pageDiv = document.getElementById('page-'  + item.page);
            const tocEl   = document.getElementById('toc-'   + item.page);
            if (!pageDiv || !tocEl) return;

            let pageWordMatches = 0;
            const lines = pageLines[item.page] || [];

            lines.forEach(line => {
                // does any word on this line match?
                const hits = line.filter(w => w.text.toLowerCase().includes(query));
                if (hits.length === 0) return;

                pageWordMatches += hits.length;

                // highlight the WHOLE line (sentence-level context)
                const bbox = lineBBox(line);
                const hl   = document.createElement('div');
                hl.className   = 'highlight-box';
                hl.style.left  = bbox.x + '%';
                hl.style.top   = bbox.y + '%';
                hl.style.width = bbox.w + '%';
                hl.style.height= bbox.h + '%';
                pageDiv.appendChild(hl);
            });

            if (pageWordMatches > 0) {
                totalMatches += pageWordMatches;
                matchedPages++;
                if (!firstMatchPage) firstMatchPage = item.page;

                tocEl.classList.add('has-match');
                const badge = document.getElementById('badge-' + item.page);
                if (badge) { badge.style.display = 'inline'; badge.textContent = pageWordMatches; }
            } else {
                // ── FILTER: hide non-matching pages from TOC ──
                tocEl.style.display = 'none';
            }
        });

        document.getElementById('matchCount').textContent = totalMatches
            ? totalMatches + ' match' + (totalMatches !== 1 ? 'es' : '') +
              ' across ' + matchedPages + ' page' + (matchedPages !== 1 ? 's' : '')
            : 'no matches';

        if (firstMatchPage) scrollToPage(firstMatchPage);
    }

    // ── 4. KEYBOARD: Enter cycles through matching pages ──
    document.getElementById('searchInput').addEventListener('keydown', function (e) {
        if (e.key !== 'Enter') return;
        const matches = [...document.querySelectorAll('.toc-item.has-match')];
        if (!matches.length) return;
        const active  = document.querySelector('.toc-item.active');
        let idx       = active ? matches.indexOf(active) : -1;
        idx           = (idx + 1) % matches.length;
        const target  = matches[idx];
        document.querySelectorAll('.toc-item').forEach(i => i.classList.remove('active'));
        target.classList.add('active');
        const pageNum = target.id.replace('toc-', '');
        document.getElementById('wrapper-' + pageNum)
                .scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // ── 5. Wire input ──
    document.getElementById('searchInput').addEventListener('input', performSearch);

    function escHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    init();
})();
</script>
</body>
</html>
