<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forensic Evidence Viewer — ESSENTIAL EVIDENCE BUNDLE</title>
<script src="data.js"></script>
<style>
    :root {
      --black:   #0b0c0c;
      --white:   #ffffff;
      --grey-1:  #6f777b;
      --grey-2:  #bfc1c3;
      --grey-3:  #dee0e2;
      --grey-4:  #f8f8f8;
      --blue:    #1d70b8;
      --focus:   #ffdd00;
      --red:     #d4351c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--grey-4);
      color: var(--black);
      font-family: "GDS Transport", "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
      font-size: 16px;
    }

    /* ── HERO ── */
    .hero-banner { flex-shrink: 0; width: 100%; }
    .hero-img    { display: block; width: 100%; height: auto; }

    /* ── THREE-PANEL ROW ── */
    .panels-row { display: flex; flex: 1; overflow: hidden; }

    /* ── LEFT: TOC ── */
    .toc-panel {
      width: 300px;
      background: var(--white);
      border-right: 1px solid var(--grey-3);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .search-box {
      padding: 14px 16px;
      border-bottom: 1px solid var(--grey-3);
      flex-shrink: 0;
    }
    .search-label {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--black);
      margin-bottom: 5px;
    }
    input[type="text"] {
      width: 100%;
      background: var(--white);
      border: 2px solid var(--grey-2);
      color: var(--black);
      padding: 8px 10px;
      font-family: inherit;
      font-size: 16px;
      outline: none;
      border-radius: 0;
    }
    input[type="text"]:focus {
      outline: 3px solid var(--focus);
      outline-offset: 0;
      border-color: var(--black);
    }
    #matchCount {
      font-size: 13px;
      color: var(--blue);
      font-weight: 700;
      margin-top: 5px;
      min-height: 18px;
    }
    .stats-bar {
      padding: 6px 16px;
      background: var(--grey-4);
      border-bottom: 1px solid var(--grey-3);
      font-size: 12px;
      color: var(--grey-1);
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .toc-list { overflow-y: auto; flex: 1; }
    .toc-item {
      padding: 9px 14px 9px 16px;
      border-bottom: 1px solid var(--grey-3);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.12s;
      border-left: 4px solid transparent;
    }
    .toc-item:hover            { background: #f0f2f4; }
    .toc-item.active           { background: #eef2f7; border-left-color: var(--blue); }
    .toc-item.has-match        { border-left-color: var(--focus); background: #fffdf0; }
    .toc-item.active.has-match { border-left-color: var(--blue); background: #eef2f7; }
    .page-num   { color: var(--blue); font-weight: 700; font-size: 14px; }
    .page-title {
      font-size: 12px;
      color: var(--grey-1);
      margin-top: 2px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .match-badge {
      background: var(--focus);
      color: var(--black);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 2px;
      white-space: nowrap;
    }

    /* ── CENTRE: VIEWER ── */
    .viewer-panel {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      background: #e8eaec;
      display: flex;
      flex-direction: column;
      align-items: center;
      scroll-behavior: smooth;
    }
    .page-wrapper       { margin-bottom: 24px; text-align: left; }
    .page-label         { font-size: 13px; font-weight: 700; color: var(--grey-1); margin-bottom: 4px; }
    .evidence-page      { position: relative; display: inline-block; background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.12); }
    .evidence-img       { display: block; max-height: calc(100vh - 200px); max-width: calc(100vw - 580px); width: auto; height: auto; }

    /* ── PAGE COPY BUTTON ── */
    .page-copy-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      z-index: 20;
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--blue);
      border-radius: 3px;
      color: var(--blue);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      cursor: pointer;
      line-height: 1.3;
      font-family: inherit;
    }
    .page-copy-btn:hover { background: var(--blue); color: var(--white); }

    /* ── HIGHLIGHT OVERLAY ── */
    .highlight-box {
      position: absolute;
      background: rgb(255, 221, 0);
      mix-blend-mode: darken;
      border: none;
      pointer-events: none;
      z-index: 10;
      animation: hl-pulse 2s ease-in-out infinite;
    }
    @keyframes hl-pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

    /* ── RIGHT: EVIDENCE COLUMN ── */
    .evidence-panel {
      width: 230px;
      background: var(--white);
      border-left: 1px solid var(--grey-3);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .ev-header {
      padding: 9px 10px;
      background: var(--black);
      color: var(--white);
      font-size: 13px;
      font-weight: 700;
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ev-header-left  { display: flex; align-items: center; gap: 7px; }
    .ev-count        { background: var(--blue); color: var(--white); font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 8px; }
    .ev-download {
      background: var(--blue);
      color: var(--white);
      border: none;
      padding: 5px 8px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 2px;
      font-family: inherit;
    }
    .ev-download:hover    { background: #145da6; }
    .ev-download:disabled { background: var(--grey-2); cursor: default; }
    .ev-list  { overflow-y: auto; flex: 1; padding: 6px; }
    .ev-empty { font-size: 12px; color: var(--grey-1); text-align: center; padding: 20px 10px; line-height: 1.4; }
    .ev-item  { border: 1px solid var(--grey-3); border-radius: 3px; margin-bottom: 6px; padding: 7px; background: var(--grey-4); }
    .ev-item-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .ev-num   { background: var(--blue); color: var(--white); font-size: 11px; font-weight: 700; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .ev-meta  { font-size: 11px; color: var(--grey-1); }
    .ev-rm    { background: none; border: none; color: var(--grey-1); font-size: 16px; cursor: pointer; line-height: 1; padding: 0 2px; }
    .ev-rm:hover { color: var(--red); }
    .ev-notes { font-size: 9px; color: var(--grey-1); margin-top: 5px; line-height: 1.35; }
    .ev-thumb { position: relative; width: 100%; }
    .ev-thumb img { display: block; width: 100%; height: auto; }
    .ev-hl    { position: absolute; background: rgb(255, 221, 0); mix-blend-mode: darken; pointer-events: none; }
    .ev-banner {
      position: absolute; top: 0; left: 0; right: 0;
      height: 17px;
      background: #0b0c0c;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 5px;
      z-index: 5; pointer-events: none;
    }
    .ev-banner span { color: #fff; font-size: 7.5px; font-weight: 700; text-transform: uppercase; white-space: nowrap; letter-spacing: .04em; }

    /* ── SCROLLBARS ── */
    ::-webkit-scrollbar            { width: 7px; }
    ::-webkit-scrollbar-track      { background: var(--white); }
    ::-webkit-scrollbar-thumb      { background: var(--grey-2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover{ background: var(--grey-1); }

    /* ── KEYBOARD HINT ── */
    .kb {
      position: fixed; bottom: 10px; right: 246px;
      font-size: 11px; color: var(--grey-1);
      pointer-events: none; z-index: 100;
      background: rgba(255,255,255,0.88);
      padding: 4px 10px; border-radius: 3px;
      border: 1px solid var(--grey-3);
    }
</style>
</head>
<body>

<!-- HERO -->
<div class="hero-banner">
    <img src="https://tvecnfdqakrevzaeifpk.supabase.co/storage/v1/object/public/MONA/JM-HEADER.svg" class="hero-img" alt="Justice Minds Forensic Intelligence Ltd">
</div>

<!-- THREE-PANEL ROW -->
<div class="panels-row">

<!-- LEFT: TOC + SEARCH -->
<div class="toc-panel">
    <div class="search-box">
        <label class="search-label" for="searchInput">Search</label>
        <input type="text" id="searchInput" placeholder="e.g. complaint, safeguarding…">
        <div id="matchCount"></div>
    </div>
    <div class="stats-bar">
        <span>Leah Farrer</span>
        <span id="statsPages"></span>
        <span id="statsWords"></span>
    </div>
    <div class="toc-list" id="tocList"></div>
</div>

<!-- CENTRE: VIEWER -->
<div class="viewer-panel" id="viewerPanel"></div>

<!-- RIGHT: EVIDENCE COLUMN -->
<div class="evidence-panel">
    <div class="ev-header">
        <div class="ev-header-left">Evidence <span class="ev-count" id="evCount">0</span></div>
        <button class="ev-download" id="evDownload" disabled>DOWNLOAD</button>
    </div>
    <div class="ev-list" id="evList">
        <div class="ev-empty">Hit ⊕ Copy on any page to save it here.</div>
    </div>
</div>

</div><!-- end panels-row -->

<div class="kb">↑↓ scroll &nbsp;|&nbsp; type to search</div>

<script>
(function () {
    const viewer   = document.getElementById('viewerPanel');
    const tocList  = document.getElementById('tocList');
    const evList   = document.getElementById('evList');
    const evCount  = document.getElementById('evCount');
    const evDl     = document.getElementById('evDownload');
    const TOTAL_PAGES = typeof EVIDENCE_DATA !== 'undefined' ? EVIDENCE_DATA.length : 0;

    // ── state ──
    const pageLines   = {};       // { pageNum → [[word,…], …] }
    const pinnedPages = [];       // [{page, query, bboxes:[{x,y,w,h}], imageSrc}]
    let   currentQuery = '';      // active search term

    // ── line grouping ──
    function groupLines(wordMap) {
        if (!wordMap || !wordMap.length) return [];
        const sorted = [...wordMap].sort((a, b) => a.y - b.y || a.x - b.x);
        const lines  = [];
        let cur      = [sorted[0]];
        for (let i = 1; i < sorted.length; i++) {
            if (Math.abs(sorted[i].y - cur[0].y) < 1.2) {
                cur.push(sorted[i]);
            } else {
                lines.push(cur);
                cur = [sorted[i]];
            }
        }
        lines.push(cur);
        return lines;
    }

    function lineBBox(line) {
        let x1 = Infinity, y1 = Infinity, x2 = -Infinity, y2 = -Infinity;
        for (const w of line) {
            if (w.x         < x1) x1 = w.x;
            if (w.y         < y1) y1 = w.y;
            if (w.x + w.w   > x2) x2 = w.x + w.w;
            if (w.y + w.h   > y2) y2 = w.y + w.h;
        }
        return { x: x1, y: y1, w: x2 - x1, h: y2 - y1 };
    }

    // ── 1. INIT ──
    function init() {
        if (typeof EVIDENCE_DATA === 'undefined') {
            viewer.innerHTML = '<p style="color:#d4351c;font-size:18px;margin-top:100px">'
                + 'Error: data.js not loaded.</p>';
            return;
        }

        let totalWords = 0;
        EVIDENCE_DATA.forEach(item => {
            totalWords += item.word_map.length;
            pageLines[item.page] = groupLines(item.word_map);

            // TOC entry
            const tocItem        = document.createElement('div');
            tocItem.className    = 'toc-item';
            tocItem.id           = 'toc-' + item.page;
            tocItem.innerHTML    =
                '<div><span class="page-num">Page ' + item.page + '</span>' +
                '<div class="page-title">' + escHtml(item.title) + '</div></div>' +
                '<span class="match-badge" id="badge-' + item.page + '" style="display:none"></span>';
            tocItem.onclick      = () => scrollToPage(item.page);
            tocList.appendChild(tocItem);

            // Viewer page
            const wrapper        = document.createElement('div');
            wrapper.className    = 'page-wrapper';
            wrapper.id           = 'wrapper-' + item.page;

            const label          = document.createElement('div');
            label.className      = 'page-label';
            label.textContent    = 'Page ' + item.page + ' of ' + TOTAL_PAGES;

            const pageDiv        = document.createElement('div');
            pageDiv.className    = 'evidence-page';
            pageDiv.id           = 'page-' + item.page;
            pageDiv.innerHTML    = '<img src="' + item.image + '" class="evidence-img">';

            // ── copy button ──
            const copyBtn        = document.createElement('button');
            copyBtn.className    = 'page-copy-btn';
            copyBtn.textContent  = '⊕ Copy';
            copyBtn.addEventListener('click', () => copyPage(item.page));
            pageDiv.appendChild(copyBtn);

            wrapper.appendChild(label);
            wrapper.appendChild(pageDiv);
            viewer.appendChild(wrapper);
        });

        document.getElementById('statsPages').textContent = TOTAL_PAGES + ' pages';
        document.getElementById('statsWords').textContent  = totalWords.toLocaleString() + ' indexed words';
    }

    // ── 2. SCROLL ──
    function scrollToPage(pageNum) {
        const el    = document.getElementById('wrapper-' + pageNum);
        const tocEl = document.getElementById('toc-'     + pageNum);
        document.querySelectorAll('.toc-item').forEach(i => i.classList.remove('active'));
        if (tocEl) tocEl.classList.add('active');
        if (el)    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ── 3. SEARCH ──
    function performSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        currentQuery = query;

        // clear highlights + badges
        document.querySelectorAll('.highlight-box').forEach(el => el.remove());
        document.querySelectorAll('.toc-item').forEach(i => {
            i.classList.remove('has-match', 'active');
            i.style.display = '';
        });
        document.querySelectorAll('.match-badge').forEach(b => {
            b.style.display = 'none';
            b.textContent   = '';
        });

        if (query.length < 2) {
            document.getElementById('matchCount').textContent = '';
            return;
        }

        const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re      = new RegExp('\\b' + escaped.replace(/ +/g, '\\s+') + '\\b');

        let totalMatches = 0, matchedPages = 0, firstMatchPage = null;

        EVIDENCE_DATA.forEach(item => {
            const pageDiv = document.getElementById('page-'  + item.page);
            const tocEl   = document.getElementById('toc-'   + item.page);
            if (!pageDiv || !tocEl) return;

            let pageWordMatches = 0;
            const lines = pageLines[item.page] || [];

            lines.forEach(line => {
                const lineText = line.map(w => w.text).join(' ').toLowerCase();
                if (!re.test(lineText)) return;

                pageWordMatches++;

                const bbox = lineBBox(line);
                const hl   = document.createElement('div');
                hl.className    = 'highlight-box';
                hl.style.left   = bbox.x + '%';
                hl.style.top    = bbox.y + '%';
                hl.style.width  = bbox.w + '%';
                hl.style.height = bbox.h + '%';
                pageDiv.appendChild(hl);
            });

            if (pageWordMatches > 0) {
                totalMatches += pageWordMatches;
                matchedPages++;
                if (!firstMatchPage) firstMatchPage = item.page;

                tocEl.classList.add('has-match');
                const badge = document.getElementById('badge-' + item.page);
                if (badge) { badge.style.display = 'inline'; badge.textContent = pageWordMatches; }
            } else {
                tocEl.style.display = 'none';
            }
        });

        document.getElementById('matchCount').textContent = totalMatches
            ? totalMatches + ' match' + (totalMatches !== 1 ? 'es' : '') +
              ' across ' + matchedPages + ' page' + (matchedPages !== 1 ? 's' : '')
            : 'no matches';

        if (firstMatchPage) scrollToPage(firstMatchPage);
    }

    // ── 4. KEYBOARD: Enter cycles matches ──
    document.getElementById('searchInput').addEventListener('keydown', function (e) {
        if (e.key !== 'Enter') return;
        const matches = [...document.querySelectorAll('.toc-item.has-match')];
        if (!matches.length) return;
        const active  = document.querySelector('.toc-item.active');
        let idx       = active ? matches.indexOf(active) : -1;
        idx           = (idx + 1) % matches.length;
        const target  = matches[idx];
        document.querySelectorAll('.toc-item').forEach(i => i.classList.remove('active'));
        target.classList.add('active');
        const pageNum = target.id.replace('toc-', '');
        document.getElementById('wrapper-' + pageNum)
                .scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // ── 5. Wire search ──
    document.getElementById('searchInput').addEventListener('input', performSearch);

    // ── 6. COPY / EVIDENCE COLUMN ──
    function copyPage(pageNum) {
        // snapshot current highlights for this page — frozen in time
        const pageDiv = document.getElementById('page-' + pageNum);
        const hls     = pageDiv ? [...pageDiv.querySelectorAll('.highlight-box')] : [];
        const bboxes  = hls.map(el => ({
            x: parseFloat(el.style.left),
            y: parseFloat(el.style.top),
            w: parseFloat(el.style.width),
            h: parseFloat(el.style.height)
        }));
        const img = pageDiv ? pageDiv.querySelector('img') : null;

        pinnedPages.push({
            page:     pageNum,
            query:    currentQuery || '(no search)',
            bboxes:   bboxes,
            imageSrc: img ? img.src : ''
        });
        renderEvidence();
    }

    function removePin(idx) {
        pinnedPages.splice(idx, 1);
        renderEvidence();
    }

    function renderEvidence() {
        evCount.textContent = pinnedPages.length;
        evDl.disabled       = pinnedPages.length === 0;

        if (pinnedPages.length === 0) {
            evList.innerHTML = '<div class="ev-empty">Hit ⊕ Copy on any page to save it here.</div>';
            return;
        }

        evList.innerHTML = '';
        pinnedPages.forEach((entry, idx) => {
            const item = document.createElement('div');
            item.className = 'ev-item';

            // header row: number + remove button
            const head = document.createElement('div');
            head.className = 'ev-item-head';
            head.innerHTML =
                '<span class="ev-num">' + (idx + 1) + '</span>' +
                '<button class="ev-rm" title="Remove">&times;</button>';
            head.querySelector('.ev-rm').addEventListener('click', () => removePin(idx));

            // thumbnail + highlight overlays
            const thumb = document.createElement('div');
            thumb.className = 'ev-thumb';
            const tImg      = document.createElement('img');
            tImg.src        = entry.imageSrc;
            thumb.appendChild(tImg);

            entry.bboxes.forEach(bb => {
                const hl        = document.createElement('div');
                hl.className    = 'ev-hl';
                hl.style.left   = bb.x + '%';
                hl.style.top    = bb.y + '%';
                hl.style.width  = bb.w + '%';
                hl.style.height = bb.h + '%';
                thumb.appendChild(hl);
            });

            // navy banner overlay on thumbnail
            const banner = document.createElement('div');
            banner.className = 'ev-banner';
            banner.innerHTML = '<span>' + escHtml(entry.query) + '</span><span>Exhibit ' + (idx + 1) + '</span>';
            thumb.appendChild(banner);

            // notes line below thumbnail
            const pd    = EVIDENCE_DATA.find(d => d.page === entry.page);
            const docTitle = pd ? pd.title.replace(/\u2026$/, '') : 'Page ' + entry.page;
            const notes = document.createElement('div');
            notes.className = 'ev-notes';
            notes.textContent = docTitle + ' | "' + entry.query + '" | Page: ' + entry.page + ' of ' + TOTAL_PAGES;

            item.appendChild(head);
            item.appendChild(thumb);
            item.appendChild(notes);
            evList.appendChild(item);
        });
    }

    // ── 7. DOWNLOAD — print-to-PDF ──
    evDl.addEventListener('click', downloadAll);

    async function downloadAll() {
        if (!pinnedPages.length) return;
        evDl.disabled    = true;
        evDl.textContent = 'Generating…';

        // render each exhibit to canvas with highlights baked in
        const renderExhibit = (entry) => new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas  = document.createElement('canvas');
                canvas.width  = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx     = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                ctx.globalCompositeOperation = 'darken';
                ctx.fillStyle = 'rgb(255, 221, 0)';
                entry.bboxes.forEach(bb => {
                    ctx.fillRect(
                        bb.x / 100 * canvas.width,
                        bb.y / 100 * canvas.height,
                        bb.w / 100 * canvas.width,
                        bb.h / 100 * canvas.height
                    );
                });
                ctx.globalCompositeOperation = 'source-over';
                resolve(canvas.toDataURL('image/jpeg', 0.88));
            };
            img.src = entry.imageSrc;
        });

        const dataUrls = await Promise.all(pinnedPages.map(renderExhibit));

        // ── TOC rows ──
        const tocRows = pinnedPages.map((entry, i) => {
            const pd    = EVIDENCE_DATA.find(d => d.page === entry.page);
            const title = pd ? pd.title.replace(/\u2026$/, '') : 'Page ' + entry.page;
            return '<tr>' +
                '<td><strong>Exhibit ' + (i + 1) + '</strong></td>' +
                '<td>' + escHtml(title) + '</td>' +
                '<td>' + entry.page + '</td>' +
                '<td style="font-size:10pt;font-style:italic;">"' + escHtml(entry.query) + '"</td>' +
                '</tr>';
        }).join('');

        // ── exhibit pages ──
        var totalPages = EVIDENCE_DATA.length;
        const exhibitPages = pinnedPages.map((entry, i) => {
            const pd    = EVIDENCE_DATA.find(d => d.page === entry.page);
            const title = pd ? pd.title.replace(/\u2026$/, '') : 'Page ' + entry.page;
            return '<div class="page-break"></div>' +
                '<div class="exhibit-page">' +
                    '<div class="exhibit-banner">' +
                        '<span>' + escHtml(entry.query.toUpperCase()) + '</span>' +
                        '<span>EXHIBIT ' + (i + 1) + '</span>' +
                    '</div>' +
                    '<div class="exhibit-body">' +
                        '<img src="' + dataUrls[i] + '" class="exhibit-img">' +
                    '</div>' +
                    '<div class="exhibit-footer">' +
                        'Document: ' + escHtml(title) + '&nbsp;&nbsp;|&nbsp;&nbsp;"' + escHtml(entry.query) + '"&nbsp;&nbsp;|&nbsp;&nbsp;Page: ' + entry.page + ' of ' + totalPages +
                    '</div>' +
                '</div>';
        }).join('');

        // ── assemble HTML ──
        var dateStr = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        var html =
'<!DOCTYPE html><html><head><meta charset="UTF-8">' +
'<title>Essential Evidence Bundle</title>' +
'<style>' +
'  @page { size: A4; margin: 0; }' +
'  * { box-sizing: border-box; }' +
'  body { margin:0; padding:0; font-family:"Times New Roman",serif; font-size:12pt; line-height:1.5; color:#000; }' +
'  .toc-page { padding: 2.5cm 2cm 2cm; }' +
'  .toc-title { text-align:center; margin-bottom:28px; }' +
'  .toc-title h1 { font-size:20pt; margin-bottom:6px; }' +
'  .toc-title .sub { font-size:13pt; font-weight:normal; color:#333; }' +
'  .toc-title .dt  { font-size:10pt; color:#666; margin-top:8px; }' +
'  .toc-title h3   { font-size:13pt; margin-bottom:10px; border-bottom:2px solid #000; padding-bottom:5px; text-align:left; }' +
'  table { width:100%; border-collapse:collapse; }' +
'  th,td { border:1px solid #000; padding:7px 9px; text-align:left; vertical-align:top; }' +
'  th { background:#f5f5f5; font-size:10pt; }' +
'  td { font-size:11pt; }' +
'  .page-break { page-break-before:always; }' +
'  .exhibit-page { display:flex; flex-direction:column; height:29.7cm; page-break-inside:avoid; }' +
'  .exhibit-banner { background:#0b0c0c; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 2cm; font-weight:bold; font-size:14pt; font-family:"Helvetica Neue",Arial,sans-serif; letter-spacing:.05em; flex-shrink:0; }' +
'  .exhibit-body { flex:1; display:flex; align-items:center; justify-content:center; padding:0.6cm 2cm; overflow:hidden; }' +
'  .exhibit-img { max-width:100%; max-height:100%; object-fit:contain; box-shadow:0 1px 6px rgba(0,0,0,0.15); }' +
'  .exhibit-footer { flex-shrink:0; border-top:1px solid #ccc; padding:0.4cm 2cm; font-size:9pt; color:#555; font-family:"Helvetica Neue",Arial,sans-serif; }' +
'</style>' +
'</head><body>' +
'<div class="toc-page">' +
'  <div class="toc-title">' +
'    <h1>ESSENTIAL EVIDENCE BUNDLE</h1>' +
'    <div class="sub">Leah Farrer v. Notting Hill Genesis</div>' +
'    <div class="dt">Generated: ' + dateStr + '</div>' +
'  </div>' +
'  <h3>Index of Exhibits</h3>' +
'  <table><thead><tr>' +
'    <th style="width:70px;">Exhibit</th>' +
'    <th>Document</th>' +
'    <th style="width:42px;">Page</th>' +
'    <th>Highlighted Text</th>' +
'  </tr></thead><tbody>' + tocRows + '</tbody></table>' +
'</div>' +
exhibitPages +
'</body></html>';

        // open + auto-print
        var blob     = new Blob([html], { type: 'text/html' });
        var url      = URL.createObjectURL(blob);
        var printWin = window.open(url, '_blank');
        if (printWin) {
            printWin.onload = function () {
                setTimeout(function () { printWin.print(); }, 600);
            };
        }

        evDl.disabled    = false;
        evDl.textContent = 'DOWNLOAD';
    }

    // ── util ──
    function escHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    init();
})();
</script>
</body>
</html>
